<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Major & Minor Values Histogram</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-wrapper {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .chart-title {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffffff;
        }
        .chart-canvas {
            max-height: 300px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 12px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            color: #888;
        }
        .stat-value {
            color: #fff;
            font-weight: bold;
        }
        .controls {
            margin-top: 15px;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .input-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 3px;
        }
        .input-field {
            padding: 5px 8px;
            border: 1px solid #666;
            border-radius: 3px;
            background-color: #333;
            color: white;
            font-size: 12px;
            width: 80px;
        }
        .submit-btn {
            padding: 8px 15px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .submit-btn:hover {
            background-color: #005a9e;
        }
        .submit-btn:disabled {
            background-color: #666 !important;
            cursor: not-allowed !important;
        }
        .submit-btn:disabled:hover {
            background-color: #666 !important;
        }
        .submit-btn[style*="background-color: #dc3545"]:hover {
            background-color: #c82333 !important;
        }
        .stored-values {
            margin-top: 10px;
            font-size: 12px;
        }
        .stored-label {
            color: #888;
            margin-right: 5px;
        }
        .stored-value {
            color: #4CAF50;
            font-weight: bold;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Major & Minor Values Distribution</h1>
        <p>Live histogram of all symbol combinations</p>
    </div>
    
    <div id="charts-container" class="charts-container">
        <!-- Charts will be dynamically generated here -->
    </div>

    <script>
        let charts = {};
        let symbolData = {};
        let storedValues = {}; // Store submitted values for each symbol combination
        let executionStates = {}; // Track execution state for each symbol combination (0=Inactive, 1=Active)
        
        // WebSocket connection to receive data
        const ws = new WebSocket('ws://localhost:8080');
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'histogram-update') {
                    updateHistograms(data.symbols, data.activeSymbols, data.minGaps, data.prices);
                } else if (data.type === 'major-reset') {
                    // Reset major execution state for specified symbol combination
                    if (data.symbolKey) {
                        resetMajorExecutionState(data.symbolKey);
                    }
                } else if (data.type === 'minor-reset') {
                    // Reset minor execution state for specified symbol combination
                    if (data.symbolKey) {
                        resetMinorExecutionState(data.symbolKey);
                    }
                } else if (data.type === 'major-trigger-update') {
                    // Update remaining major trigger count
                    if (data.symbolKey && data.remainingTriggers !== undefined) {
                        updateMajorRemainingTriggers(data.symbolKey, data.remainingTriggers);
                    }
                } else if (data.type === 'minor-trigger-update') {
                    // Update remaining minor trigger count
                    if (data.symbolKey && data.remainingTriggers !== undefined) {
                        updateMinorRemainingTriggers(data.symbolKey, data.remainingTriggers);
                    }
                } else if (data.type === 'state-update') {
                    // Handle state updates for compatibility
                    if (data.symbolKey && data.state) {
                        updateExecutionState(data.symbolKey, data.state);
                    }
                }
            } catch (error) {
                console.error('Error parsing WebSocket data:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocket connection closed');
        };
        
        function updateHistograms(symbols, activeSymbols, minGaps, prices) {
            const container = document.getElementById('charts-container');
            
            // Remove charts that are no longer active
            Object.keys(charts).forEach(symbolKey => {
                if (!activeSymbols.includes(symbolKey)) {
                    // Remove the chart
                    charts[symbolKey].destroy();
                    delete charts[symbolKey];
                    
                    // Clean up stored values and execution state for removed symbol
                    delete storedValues[symbolKey];
                    delete executionStates[symbolKey];
                    
                    // Remove the wrapper element using safe ID
                    const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
                    const wrapper = document.getElementById(`wrapper-${safeId}`);
                    if (wrapper) {
                        wrapper.remove();
                    }
                }
            });
            
            // Update or create charts for active symbols
            Object.keys(symbols).forEach(symbolKey => {
                const data = symbols[symbolKey];
                
                if (!charts[symbolKey]) {
                    createChart(symbolKey, data, minGaps, prices);
                } else {
                    updateChart(symbolKey, data, minGaps, prices);
                }
            });
        }
        
        function createChart(symbolKey, data, minGaps, prices) {
            const container = document.getElementById('charts-container');
            
            // Create safe ID by replacing special characters
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Create chart wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            wrapper.id = `wrapper-${safeId}`;
            
            // Create title
            const title = document.createElement('div');
            title.className = 'chart-title';
            title.textContent = symbolKey;
            wrapper.appendChild(title);
            
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.id = `chart-${safeId}`;
            canvas.className = 'chart-canvas';
            wrapper.appendChild(canvas);
            
            // Create stats div
            const stats = document.createElement('div');
            stats.className = 'stats';
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Major Samples</div>
                    <div class="stat-value" id="major-count-${safeId}">${data.majorValues.length}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Minor Samples</div>
                    <div class="stat-value" id="minor-count-${safeId}">${data.minorValues.length}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Min Gap</div>
                    <div class="stat-value" id="min-gap-${safeId}">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Price</div>
                    <div class="stat-value" id="price-${safeId}">-</div>
                </div>
            `;
            wrapper.appendChild(stats);
            
            // Create controls section
            const controls = document.createElement('div');
            controls.className = 'controls';
            
            // Major Value Controls Row
            const majorRow = document.createElement('div');
            majorRow.className = 'input-row';
            majorRow.style.borderBottom = '1px solid #555';
            majorRow.style.paddingBottom = '10px';
            majorRow.style.marginBottom = '10px';
            
            // Major input group
            const majorGroup = document.createElement('div');
            majorGroup.className = 'input-group';
            majorGroup.innerHTML = `
                <div class="input-label">Major Value</div>
                <input type="number" step="0.0001" class="input-field" id="major-input-${safeId}" placeholder="0.0000" oninput="updateLiveDifference('${symbolKey}', '${safeId}')">
            `;
            
            // Major depth input group
            const majorDepthGroup = document.createElement('div');
            majorDepthGroup.className = 'input-group';
            majorDepthGroup.innerHTML = `
                <div class="input-label">Major Depth</div>
                <input type="number" step="1" min="1" class="input-field" id="major-depth-input-${safeId}" placeholder="1" value="1">
            `;
            
            // Major submit button
            const majorSubmitBtn = document.createElement('button');
            majorSubmitBtn.className = 'submit-btn';
            majorSubmitBtn.textContent = 'Submit Major';
            majorSubmitBtn.onclick = () => submitMajorValue(symbolKey, safeId);
            
            // Major release button
            const majorReleaseBtn = document.createElement('button');
            majorReleaseBtn.className = 'submit-btn';
            majorReleaseBtn.style.backgroundColor = '#dc3545';
            majorReleaseBtn.style.marginLeft = '5px';
            majorReleaseBtn.textContent = 'Release Major';
            majorReleaseBtn.onclick = () => releaseMajorValue(symbolKey, safeId);
            
            majorRow.appendChild(majorGroup);
            majorRow.appendChild(majorDepthGroup);
            majorRow.appendChild(majorSubmitBtn);
            majorRow.appendChild(majorReleaseBtn);
            controls.appendChild(majorRow);
            
            // Minor Value Controls Row
            const minorRow = document.createElement('div');
            minorRow.className = 'input-row';
            
            // Minor input group
            const minorGroup = document.createElement('div');
            minorGroup.className = 'input-group';
            minorGroup.innerHTML = `
                <div class="input-label">Minor Value</div>
                <input type="number" step="0.0001" class="input-field" id="minor-input-${safeId}" placeholder="0.0000" oninput="updateLiveDifference('${symbolKey}', '${safeId}')">
            `;
            
            // Minor depth input group
            const minorDepthGroup = document.createElement('div');
            minorDepthGroup.className = 'input-group';
            minorDepthGroup.innerHTML = `
                <div class="input-label">Minor Depth</div>
                <input type="number" step="1" min="1" class="input-field" id="minor-depth-input-${safeId}" placeholder="1" value="1">
            `;
            
            // Minor submit button
            const minorSubmitBtn = document.createElement('button');
            minorSubmitBtn.className = 'submit-btn';
            minorSubmitBtn.textContent = 'Submit Minor';
            minorSubmitBtn.onclick = () => submitMinorValue(symbolKey, safeId);
            
            // Minor release button
            const minorReleaseBtn = document.createElement('button');
            minorReleaseBtn.className = 'submit-btn';
            minorReleaseBtn.style.backgroundColor = '#dc3545';
            minorReleaseBtn.style.marginLeft = '5px';
            minorReleaseBtn.textContent = 'Release Minor';
            minorReleaseBtn.onclick = () => releaseMinorValue(symbolKey, safeId);
            
            minorRow.appendChild(minorGroup);
            minorRow.appendChild(minorDepthGroup);
            minorRow.appendChild(minorSubmitBtn);
            minorRow.appendChild(minorReleaseBtn);
            controls.appendChild(minorRow);
            
            // Live difference display
            const liveDiffRow = document.createElement('div');
            liveDiffRow.className = 'input-row';
            liveDiffRow.style.marginTop = '5px';
            liveDiffRow.innerHTML = `
                <div style="flex: 1; text-align: center; font-size: 12px; color: #ffa500;">
                    <span class="stored-label">Live Difference:</span>
                    <span class="stored-value" id="live-difference-${safeId}" style="color: #ffa500;">-</span>
                </div>
            `;
            controls.appendChild(liveDiffRow);
            
            // Stored values display
            const storedDisplay = document.createElement('div');
            storedDisplay.className = 'stored-values';
            storedDisplay.id = `stored-display-${safeId}`;
            storedDisplay.innerHTML = `
                <div style="margin-bottom: 5px;">
                    <span class="stored-label">Major:</span><span class="stored-value" id="stored-major-${safeId}">-</span>
                    <span class="stored-label">Depth:</span><span class="stored-value" id="major-depth-${safeId}">-</span>
                    <span class="stored-label">Remaining:</span><span class="stored-value" id="major-remaining-${safeId}">-</span>
                    <span class="stored-label">State:</span><span class="stored-value" id="major-state-${safeId}" style="color: #ff6b6b;">Inactive</span>
                </div>
                <div>
                    <span class="stored-label">Minor:</span><span class="stored-value" id="stored-minor-${safeId}">-</span>
                    <span class="stored-label">Depth:</span><span class="stored-value" id="minor-depth-${safeId}">-</span>
                    <span class="stored-label">Remaining:</span><span class="stored-value" id="minor-remaining-${safeId}">-</span>
                    <span class="stored-label">State:</span><span class="stored-value" id="minor-state-${safeId}" style="color: #ff6b6b;">Inactive</span>
                </div>
            `;
            controls.appendChild(storedDisplay);
            
            wrapper.appendChild(controls);
            container.appendChild(wrapper);
            
            // Set initial Min Gap and Price values
            if (minGaps && minGaps[symbolKey]) {
                document.getElementById(`min-gap-${safeId}`).textContent = minGaps[symbolKey];
            }
            if (prices && prices[symbolKey]) {
                document.getElementById(`price-${safeId}`).textContent = prices[symbolKey];
            }
            
            // Restore previously stored values if they exist
            if (storedValues[symbolKey]) {
                // Restore Major values
                if (storedValues[symbolKey].major !== undefined) {
                    document.getElementById(`stored-major-${safeId}`).textContent = storedValues[symbolKey].major.toFixed(4);
                    document.getElementById(`major-depth-${safeId}`).textContent = storedValues[symbolKey].majorDepth || '-';
                    document.getElementById(`major-remaining-${safeId}`).textContent = storedValues[symbolKey].majorRemaining || '-';
                    document.getElementById(`major-state-${safeId}`).textContent = 'Active';
                    document.getElementById(`major-state-${safeId}`).style.color = '#4CAF50';
                }
                
                // Restore Minor values
                if (storedValues[symbolKey].minor !== undefined) {
                    document.getElementById(`stored-minor-${safeId}`).textContent = storedValues[symbolKey].minor.toFixed(4);
                    document.getElementById(`minor-depth-${safeId}`).textContent = storedValues[symbolKey].minorDepth || '-';
                    document.getElementById(`minor-remaining-${safeId}`).textContent = storedValues[symbolKey].minorRemaining || '-';
                    document.getElementById(`minor-state-${safeId}`).textContent = 'Active';
                    document.getElementById(`minor-state-${safeId}`).style.color = '#4CAF50';
                }
            }
            
            // Create histogram data
            const majorHist = createHistogramData(data.majorValues, 20);
            const minorHist = createHistogramData(data.minorValues, 20);
            
            // Create chart
            const ctx = canvas.getContext('2d');
            charts[symbolKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: majorHist.labels,
                    datasets: [{
                        label: 'Major Values',
                        data: majorHist.data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Minor Values',
                        data: minorHist.data,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
        
        function updateChart(symbolKey, data, minGaps, prices) {
            const chart = charts[symbolKey];
            if (!chart) return;
            
            // Create safe ID by replacing special characters
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Update histogram data
            const majorHist = createHistogramData(data.majorValues, 20);
            const minorHist = createHistogramData(data.minorValues, 20);
            
            chart.data.labels = majorHist.labels;
            chart.data.datasets[0].data = majorHist.data;
            chart.data.datasets[1].data = minorHist.data;
            chart.update('none'); // Update without animation for performance
            
            // Update stats
            document.getElementById(`major-count-${safeId}`).textContent = data.majorValues.length;
            document.getElementById(`minor-count-${safeId}`).textContent = data.minorValues.length;
            
            // Update Min Gap and Price
            if (minGaps && minGaps[symbolKey]) {
                document.getElementById(`min-gap-${safeId}`).textContent = minGaps[symbolKey];
            }
            if (prices && prices[symbolKey]) {
                document.getElementById(`price-${safeId}`).textContent = prices[symbolKey];
            }
        }
        
        function createHistogramData(values, bins) {
            if (values.length === 0) return { labels: [], data: [] };
            
            const min = Math.min(...values);
            const max = Math.max(...values);
            const binWidth = (max - min) / bins;
            
            const labels = [];
            const data = new Array(bins).fill(0);
            
            // Create bin labels
            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binWidth;
                const binEnd = min + (i + 1) * binWidth;
                labels.push(`${binStart.toFixed(3)}-${binEnd.toFixed(3)}`);
            }
            
            // Count values in each bin
            values.forEach(value => {
                let binIndex = Math.floor((value - min) / binWidth);
                if (binIndex >= bins) binIndex = bins - 1; // Handle edge case
                if (binIndex < 0) binIndex = 0;
                data[binIndex]++;
            });
            
            return { labels, data };
        }
        
        function submitMajorValue(symbolKey, safeId) {
            const majorInput = document.getElementById(`major-input-${safeId}`);
            const majorDepthInput = document.getElementById(`major-depth-input-${safeId}`);
            
            const majorValue = parseFloat(majorInput.value);
            const majorDepth = parseInt(majorDepthInput.value);
            
            // Validate inputs
            if (isNaN(majorValue)) {
                alert('Please enter a valid number for Major value.');
                return;
            }
            
            if (isNaN(majorDepth) || majorDepth < 1) {
                alert('Please enter a valid depth (minimum 1) for Major value.');
                return;
            }
            
            // Store values
            if (!storedValues[symbolKey]) {
                storedValues[symbolKey] = {};
            }
            storedValues[symbolKey].major = majorValue;
            storedValues[symbolKey].majorDepth = majorDepth;
            storedValues[symbolKey].majorRemaining = majorDepth;
            
            // Send major activation to feed.js server
            const activationMessage = JSON.stringify({
                type: 'major-activated',
                symbolKey: symbolKey,
                storedMajor: majorValue,
                majorDepth: majorDepth,
                majorRemaining: majorDepth
            });
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(activationMessage);
                console.log(`Sent Major activation signal for ${symbolKey}`);
            }
            
            // Update display
            document.getElementById(`stored-major-${safeId}`).textContent = majorValue.toFixed(4);
            document.getElementById(`major-depth-${safeId}`).textContent = majorDepth;
            document.getElementById(`major-remaining-${safeId}`).textContent = majorDepth;
            document.getElementById(`major-state-${safeId}`).textContent = 'Active';
            document.getElementById(`major-state-${safeId}`).style.color = '#4CAF50';
            
            // Disable major submit button and store reference
            const majorSubmitBtn = document.querySelector(`#wrapper-${safeId} button[onclick*="submitMajorValue"]`);
            if (majorSubmitBtn) {
                majorSubmitBtn.disabled = true;
                majorSubmitBtn.style.backgroundColor = '#666';
                majorSubmitBtn.style.cursor = 'not-allowed';
                
                // Store button reference for later re-enabling
                if (!storedValues[symbolKey]) {
                    storedValues[symbolKey] = {};
                }
                storedValues[symbolKey].majorSubmitBtn = majorSubmitBtn;
            }
            
            // Clear input fields
            majorInput.value = '';
            majorDepthInput.value = '1'; // Reset to default
            
            console.log(`Major value submitted for ${symbolKey}: ${majorValue}, Depth: ${majorDepth}`);
        }
        
        function submitMinorValue(symbolKey, safeId) {
            const minorInput = document.getElementById(`minor-input-${safeId}`);
            const minorDepthInput = document.getElementById(`minor-depth-input-${safeId}`);
            
            const minorValue = parseFloat(minorInput.value);
            const minorDepth = parseInt(minorDepthInput.value);
            
            // Validate inputs
            if (isNaN(minorValue)) {
                alert('Please enter a valid number for Minor value.');
                return;
            }
            
            if (isNaN(minorDepth) || minorDepth < 1) {
                alert('Please enter a valid depth (minimum 1) for Minor value.');
                return;
            }
            
            // Store values
            if (!storedValues[symbolKey]) {
                storedValues[symbolKey] = {};
            }
            storedValues[symbolKey].minor = minorValue;
            storedValues[symbolKey].minorDepth = minorDepth;
            storedValues[symbolKey].minorRemaining = minorDepth;
            
            // Send minor activation to feed.js server
            const activationMessage = JSON.stringify({
                type: 'minor-activated',
                symbolKey: symbolKey,
                storedMinor: minorValue,
                minorDepth: minorDepth,
                minorRemaining: minorDepth
            });
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(activationMessage);
                console.log(`Sent Minor activation signal for ${symbolKey}`);
            }
            
            // Update display
            document.getElementById(`stored-minor-${safeId}`).textContent = minorValue.toFixed(4);
            document.getElementById(`minor-depth-${safeId}`).textContent = minorDepth;
            document.getElementById(`minor-remaining-${safeId}`).textContent = minorDepth;
            document.getElementById(`minor-state-${safeId}`).textContent = 'Active';
            document.getElementById(`minor-state-${safeId}`).style.color = '#4CAF50';
            
            // Disable minor submit button and store reference
            const minorSubmitBtn = document.querySelector(`#wrapper-${safeId} button[onclick*="submitMinorValue"]`);
            if (minorSubmitBtn) {
                minorSubmitBtn.disabled = true;
                minorSubmitBtn.style.backgroundColor = '#666';
                minorSubmitBtn.style.cursor = 'not-allowed';
                
                // Store button reference for later re-enabling
                if (!storedValues[symbolKey]) {
                    storedValues[symbolKey] = {};
                }
                storedValues[symbolKey].minorSubmitBtn = minorSubmitBtn;
            }
            
            // Clear input fields
            minorInput.value = '';
            minorDepthInput.value = '1'; // Reset to default
            
            console.log(`Minor value submitted for ${symbolKey}: ${minorValue}, Depth: ${minorDepth}`);
        }
        
        function releaseMajorValue(symbolKey, safeId) {
            // Send major release to feed.js server
            const releaseMessage = JSON.stringify({
                type: 'major-released',
                symbolKey: symbolKey
            });
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(releaseMessage);
                console.log(`Sent Major release signal for ${symbolKey}`);
            }
            
            // Reset major values
            if (storedValues[symbolKey]) {
                delete storedValues[symbolKey].major;
                delete storedValues[symbolKey].majorDepth;
                delete storedValues[symbolKey].majorRemaining;
            }
            
            // Update display
            document.getElementById(`stored-major-${safeId}`).textContent = '-';
            document.getElementById(`major-depth-${safeId}`).textContent = '-';
            document.getElementById(`major-remaining-${safeId}`).textContent = '-';
            document.getElementById(`major-state-${safeId}`).textContent = 'Inactive';
            document.getElementById(`major-state-${safeId}`).style.color = '#ff6b6b';
            
            // Enable major submit button using stored reference
            let majorSubmitBtn = storedValues[symbolKey] && storedValues[symbolKey].majorSubmitBtn;
            if (!majorSubmitBtn) {
                majorSubmitBtn = document.querySelector(`#wrapper-${safeId} button[onclick*="submitMajorValue"]`);
            }
            if (majorSubmitBtn) {
                majorSubmitBtn.disabled = false;
                majorSubmitBtn.style.backgroundColor = '#007acc';
                majorSubmitBtn.style.cursor = 'pointer';
            }
            
            console.log(`Major value released for ${symbolKey}`);
        }
        
        function releaseMinorValue(symbolKey, safeId) {
            // Send minor release to feed.js server
            const releaseMessage = JSON.stringify({
                type: 'minor-released',
                symbolKey: symbolKey
            });
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(releaseMessage);
                console.log(`Sent Minor release signal for ${symbolKey}`);
            }
            
            // Reset minor values
            if (storedValues[symbolKey]) {
                delete storedValues[symbolKey].minor;
                delete storedValues[symbolKey].minorDepth;
                delete storedValues[symbolKey].minorRemaining;
            }
            
            // Update display
            document.getElementById(`stored-minor-${safeId}`).textContent = '-';
            document.getElementById(`minor-depth-${safeId}`).textContent = '-';
            document.getElementById(`minor-remaining-${safeId}`).textContent = '-';
            document.getElementById(`minor-state-${safeId}`).textContent = 'Inactive';
            document.getElementById(`minor-state-${safeId}`).style.color = '#ff6b6b';
            
            // Enable minor submit button using stored reference
            let minorSubmitBtn = storedValues[symbolKey] && storedValues[symbolKey].minorSubmitBtn;
            if (!minorSubmitBtn) {
                minorSubmitBtn = document.querySelector(`#wrapper-${safeId} button[onclick*="submitMinorValue"]`);
            }
            if (minorSubmitBtn) {
                minorSubmitBtn.disabled = false;
                minorSubmitBtn.style.backgroundColor = '#007acc';
                minorSubmitBtn.style.cursor = 'pointer';
            }
            
            console.log(`Minor value released for ${symbolKey}`);
        }
        
        function resetMajorExecutionState(symbolKey) {
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Reset major values
            if (storedValues[symbolKey]) {
                delete storedValues[symbolKey].major;
                delete storedValues[symbolKey].majorDepth;
                delete storedValues[symbolKey].majorRemaining;
            }
            
            // Update display
            document.getElementById(`stored-major-${safeId}`).textContent = '-';
            document.getElementById(`major-depth-${safeId}`).textContent = '-';
            document.getElementById(`major-remaining-${safeId}`).textContent = '-';
            document.getElementById(`major-state-${safeId}`).textContent = 'Inactive';
            document.getElementById(`major-state-${safeId}`).style.color = '#ff6b6b';
            
            // Enable major submit button using stored reference
            let majorSubmitBtn = storedValues[symbolKey] && storedValues[symbolKey].majorSubmitBtn;
            if (!majorSubmitBtn) {
                majorSubmitBtn = document.querySelector(`#wrapper-${safeId} button[onclick*="submitMajorValue"]`);
            }
            if (majorSubmitBtn) {
                majorSubmitBtn.disabled = false;
                majorSubmitBtn.style.backgroundColor = '#007acc';
                majorSubmitBtn.style.cursor = 'pointer';
            }
            
            console.log(`Major execution state reset for ${symbolKey}`);
        }
        
        function resetMinorExecutionState(symbolKey) {
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Reset minor values
            if (storedValues[symbolKey]) {
                delete storedValues[symbolKey].minor;
                delete storedValues[symbolKey].minorDepth;
                delete storedValues[symbolKey].minorRemaining;
            }
            
            // Update display
            document.getElementById(`stored-minor-${safeId}`).textContent = '-';
            document.getElementById(`minor-depth-${safeId}`).textContent = '-';
            document.getElementById(`minor-remaining-${safeId}`).textContent = '-';
            document.getElementById(`minor-state-${safeId}`).textContent = 'Inactive';
            document.getElementById(`minor-state-${safeId}`).style.color = '#ff6b6b';
            
            // Enable minor submit button using stored reference
            let minorSubmitBtn = storedValues[symbolKey] && storedValues[symbolKey].minorSubmitBtn;
            if (!minorSubmitBtn) {
                minorSubmitBtn = document.querySelector(`#wrapper-${safeId} button[onclick*="submitMinorValue"]`);
            }
            if (minorSubmitBtn) {
                minorSubmitBtn.disabled = false;
                minorSubmitBtn.style.backgroundColor = '#007acc';
                minorSubmitBtn.style.cursor = 'pointer';
            }
            
            console.log(`Minor execution state reset for ${symbolKey}`);
        }
        
        function updateMajorRemainingTriggers(symbolKey, remainingCount) {
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            const remainingElement = document.getElementById(`major-remaining-${safeId}`);
            
            if (remainingElement) {
                remainingElement.textContent = remainingCount;
                
                // Update stored values
                if (storedValues[symbolKey]) {
                    storedValues[symbolKey].majorRemaining = remainingCount;
                    
                    // Re-enable submit button when depth reaches 0
                    if (remainingCount <= 0 && storedValues[symbolKey].majorSubmitBtn) {
                        const majorSubmitBtn = storedValues[symbolKey].majorSubmitBtn;
                        majorSubmitBtn.disabled = false;
                        majorSubmitBtn.style.backgroundColor = '#007acc';
                        majorSubmitBtn.style.cursor = 'pointer';
                    }
                }
                
                console.log(`Updated remaining major triggers for ${symbolKey}: ${remainingCount}`);
            }
        }
        
        function updateMinorRemainingTriggers(symbolKey, remainingCount) {
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            const remainingElement = document.getElementById(`minor-remaining-${safeId}`);
            
            if (remainingElement) {
                remainingElement.textContent = remainingCount;
                
                // Update stored values
                if (storedValues[symbolKey]) {
                    storedValues[symbolKey].minorRemaining = remainingCount;
                    
                    // Re-enable submit button when depth reaches 0
                    if (remainingCount <= 0 && storedValues[symbolKey].minorSubmitBtn) {
                        const minorSubmitBtn = storedValues[symbolKey].minorSubmitBtn;
                        minorSubmitBtn.disabled = false;
                        minorSubmitBtn.style.backgroundColor = '#007acc';
                        minorSubmitBtn.style.cursor = 'pointer';
                    }
                }
                
                console.log(`Updated remaining minor triggers for ${symbolKey}: ${remainingCount}`);
            }
        }
        
        function updateExecutionState(symbolKey, state) {
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // For backward compatibility, update both major and minor states
            const majorStateElement = document.getElementById(`major-state-${safeId}`);
            const minorStateElement = document.getElementById(`minor-state-${safeId}`);
            
            if (majorStateElement) {
                majorStateElement.textContent = state;
                majorStateElement.style.color = state === 'Active' || state === 'Trade' ? '#4CAF50' : '#ff6b6b';
            }
            
            if (minorStateElement) {
                minorStateElement.textContent = state;
                minorStateElement.style.color = state === 'Active' || state === 'Trade' ? '#4CAF50' : '#ff6b6b';
            }
            
            console.log(`Updated execution state for ${symbolKey}: ${state}`);
        }
        
        function updateLiveDifference(symbolKey, safeId) {
            const majorInput = document.getElementById(`major-input-${safeId}`);
            const minorInput = document.getElementById(`minor-input-${safeId}`);
            const liveDiffDisplay = document.getElementById(`live-difference-${safeId}`);
            
            const majorValue = parseFloat(majorInput.value);
            const minorValue = parseFloat(minorInput.value);
            
            if (!isNaN(majorValue) && !isNaN(minorValue)) {
                const difference = majorValue - minorValue;
                liveDiffDisplay.textContent = difference.toFixed(4);
            } else if (!isNaN(majorValue) && isNaN(minorValue)) {
                liveDiffDisplay.textContent = `${majorValue.toFixed(4)} - ?`;
            } else if (isNaN(majorValue) && !isNaN(minorValue)) {
                liveDiffDisplay.textContent = `? - ${minorValue.toFixed(4)}`;
            } else {
                liveDiffDisplay.textContent = '-';
            }
        }
    </script>
</body>
</html>
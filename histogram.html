<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Major & Minor Values Histogram</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-wrapper {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .chart-title {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffffff;
        }
        .chart-canvas {
            max-height: 300px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 12px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            color: #888;
        }
        .stat-value {
            color: #fff;
            font-weight: bold;
        }
        .controls {
            margin-top: 15px;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .input-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 3px;
        }
        .input-field {
            padding: 5px 8px;
            border: 1px solid #666;
            border-radius: 3px;
            background-color: #333;
            color: white;
            font-size: 12px;
            width: 80px;
        }
        .submit-btn {
            padding: 8px 15px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .submit-btn:hover {
            background-color: #005a9e;
        }
        .submit-btn:disabled {
            background-color: #666 !important;
            cursor: not-allowed !important;
        }
        .submit-btn:disabled:hover {
            background-color: #666 !important;
        }
        .stored-values {
            margin-top: 10px;
            font-size: 12px;
        }
        .stored-label {
            color: #888;
            margin-right: 5px;
        }
        .stored-value {
            color: #4CAF50;
            font-weight: bold;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Major & Minor Values Distribution</h1>
        <p>Live histogram of all symbol combinations</p>
    </div>
    
    <div id="charts-container" class="charts-container">
        <!-- Charts will be dynamically generated here -->
    </div>

    <script>
        let charts = {};
        let symbolData = {};
        let storedValues = {}; // Store submitted values for each symbol combination
        let executionStates = {}; // Track execution state for each symbol combination (0=Inactive, 1=Active)
        
        // WebSocket connection to receive data
        const ws = new WebSocket('ws://localhost:8080');
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'histogram-update') {
                    updateHistograms(data.symbols, data.activeSymbols, data.minGaps);
                } else if (data.type === 'execution-reset') {
                    // Reset execution state for specified symbol combination
                    if (data.symbolKey) {
                        resetExecutionState(data.symbolKey);
                    }
                } else if (data.type === 'trigger-count-update') {
                    // Update remaining trigger count
                    if (data.symbolKey && data.remainingTriggers !== undefined) {
                        updateRemainingTriggers(data.symbolKey, data.remainingTriggers);
                    }
                }
            } catch (error) {
                console.error('Error parsing WebSocket data:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocket connection closed');
        };
        
        function updateHistograms(symbols, activeSymbols, minGaps) {
            const container = document.getElementById('charts-container');
            
            // Remove charts that are no longer active
            Object.keys(charts).forEach(symbolKey => {
                if (!activeSymbols.includes(symbolKey)) {
                    // Remove the chart
                    charts[symbolKey].destroy();
                    delete charts[symbolKey];
                    
                    // Clean up stored values and execution state for removed symbol
                    delete storedValues[symbolKey];
                    delete executionStates[symbolKey];
                    
                    // Remove the wrapper element using safe ID
                    const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
                    const wrapper = document.getElementById(`wrapper-${safeId}`);
                    if (wrapper) {
                        wrapper.remove();
                    }
                }
            });
            
            // Update or create charts for active symbols
            Object.keys(symbols).forEach(symbolKey => {
                const data = symbols[symbolKey];
                
                if (!charts[symbolKey]) {
                    createChart(symbolKey, data, minGaps);
                } else {
                    updateChart(symbolKey, data, minGaps);
                }
            });
        }
        
        function createChart(symbolKey, data, minGaps) {
            const container = document.getElementById('charts-container');
            
            // Create safe ID by replacing special characters
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Create chart wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            wrapper.id = `wrapper-${safeId}`;
            
            // Create title
            const title = document.createElement('div');
            title.className = 'chart-title';
            title.textContent = symbolKey;
            wrapper.appendChild(title);
            
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.id = `chart-${safeId}`;
            canvas.className = 'chart-canvas';
            wrapper.appendChild(canvas);
            
            // Create stats div
            const stats = document.createElement('div');
            stats.className = 'stats';
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Major Samples</div>
                    <div class="stat-value" id="major-count-${safeId}">${data.majorValues.length}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Minor Samples</div>
                    <div class="stat-value" id="minor-count-${safeId}">${data.minorValues.length}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Min Gap</div>
                    <div class="stat-value" id="min-gap-${safeId}">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Max Major</div>
                    <div class="stat-value" id="max-major-${safeId}">${Math.max(...data.majorValues).toFixed(4)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Min Minor</div>
                    <div class="stat-value" id="min-minor-${safeId}">${Math.min(...data.minorValues).toFixed(4)}</div>
                </div>
            `;
            wrapper.appendChild(stats);
            
            // Create controls section
            const controls = document.createElement('div');
            controls.className = 'controls';
            
            // Input fields row
            const inputRow = document.createElement('div');
            inputRow.className = 'input-row';
            
            // Major input group
            const majorGroup = document.createElement('div');
            majorGroup.className = 'input-group';
            majorGroup.innerHTML = `
                <div class="input-label">Major Value</div>
                <input type="number" step="0.0001" class="input-field" id="major-input-${safeId}" placeholder="0.0000" oninput="updateLiveDifference('${symbolKey}', '${safeId}')">
            `;
            
            // Minor input group
            const minorGroup = document.createElement('div');
            minorGroup.className = 'input-group';
            minorGroup.innerHTML = `
                <div class="input-label">Minor Value</div>
                <input type="number" step="0.0001" class="input-field" id="minor-input-${safeId}" placeholder="0.0000" oninput="updateLiveDifference('${symbolKey}', '${safeId}')">
            `;
            
            // Depth input group
            const depthGroup = document.createElement('div');
            depthGroup.className = 'input-group';
            depthGroup.innerHTML = `
                <div class="input-label">Depth (Triggers)</div>
                <input type="number" step="1" min="1" class="input-field" id="depth-input-${safeId}" placeholder="1" value="1">
            `;
            
            // Submit button
            const submitBtn = document.createElement('button');
            submitBtn.className = 'submit-btn';
            submitBtn.textContent = 'Submit';
            submitBtn.onclick = () => submitValues(symbolKey, safeId);
            
            inputRow.appendChild(majorGroup);
            inputRow.appendChild(minorGroup);
            inputRow.appendChild(depthGroup);
            inputRow.appendChild(submitBtn);
            controls.appendChild(inputRow);
            
            // Live difference display
            const liveDiffRow = document.createElement('div');
            liveDiffRow.className = 'input-row';
            liveDiffRow.style.marginTop = '5px';
            liveDiffRow.innerHTML = `
                <div style="flex: 1; text-align: center; font-size: 12px; color: #ffa500;">
                    <span class="stored-label">Live Difference:</span>
                    <span class="stored-value" id="live-difference-${safeId}" style="color: #ffa500;">-</span>
                </div>
            `;
            controls.appendChild(liveDiffRow);
            
            // Stored values display
            const storedDisplay = document.createElement('div');
            storedDisplay.className = 'stored-values';
            storedDisplay.id = `stored-display-${safeId}`;
            storedDisplay.innerHTML = `
                <span class="stored-label">Stored Major:</span><span class="stored-value" id="stored-major-${safeId}">-</span>
                <span class="stored-label">Stored Minor:</span><span class="stored-value" id="stored-minor-${safeId}">-</span>
                <span class="stored-label">Difference:</span><span class="stored-value" id="stored-difference-${safeId}">-</span>
                <span class="stored-label">Depth:</span><span class="stored-value" id="stored-depth-${safeId}">-</span>
                <span class="stored-label">Remaining:</span><span class="stored-value" id="remaining-triggers-${safeId}">-</span>
                <span class="stored-label">State:</span><span class="stored-value" id="execution-state-${safeId}" style="color: #ff6b6b;">Inactive</span>
            `;
            controls.appendChild(storedDisplay);
            
            wrapper.appendChild(controls);
            container.appendChild(wrapper);
            
            // Set initial Min Gap value
            if (minGaps && minGaps[symbolKey]) {
                document.getElementById(`min-gap-${safeId}`).textContent = minGaps[symbolKey];
            }
            
            // Restore previously stored values if they exist
            if (storedValues[symbolKey]) {
                document.getElementById(`stored-major-${safeId}`).textContent = storedValues[symbolKey].major.toFixed(4);
                document.getElementById(`stored-minor-${safeId}`).textContent = storedValues[symbolKey].minor.toFixed(4);
                document.getElementById(`stored-difference-${safeId}`).textContent = storedValues[symbolKey].difference.toFixed(4);
                document.getElementById(`stored-depth-${safeId}`).textContent = storedValues[symbolKey].depth || '-';
                document.getElementById(`remaining-triggers-${safeId}`).textContent = storedValues[symbolKey].remainingTriggers || '-';
            }
            
            // Restore execution state if it exists
            if (executionStates[symbolKey] !== undefined) {
                const isActive = executionStates[symbolKey] === 1;
                document.getElementById(`execution-state-${safeId}`).textContent = isActive ? 'Active' : 'Inactive';
                document.getElementById(`execution-state-${safeId}`).style.color = isActive ? '#4CAF50' : '#ff6b6b';
                
                // Set button state accordingly
                const submitBtn = document.querySelector(`#wrapper-${safeId} .submit-btn`);
                if (submitBtn) {
                    submitBtn.disabled = isActive;
                    submitBtn.style.backgroundColor = isActive ? '#666' : '#007acc';
                    submitBtn.style.cursor = isActive ? 'not-allowed' : 'pointer';
                }
            } else {
                // Initialize execution state to Inactive (0) for new symbols
                executionStates[symbolKey] = 0;
            }
            
            // Create histogram data
            const majorHist = createHistogramData(data.majorValues, 20);
            const minorHist = createHistogramData(data.minorValues, 20);
            
            // Create chart
            const ctx = canvas.getContext('2d');
            charts[symbolKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: majorHist.labels,
                    datasets: [{
                        label: 'Major Values',
                        data: majorHist.data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Minor Values',
                        data: minorHist.data,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
        
        function updateChart(symbolKey, data, minGaps) {
            const chart = charts[symbolKey];
            if (!chart) return;
            
            // Create safe ID by replacing special characters
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Update histogram data
            const majorHist = createHistogramData(data.majorValues, 20);
            const minorHist = createHistogramData(data.minorValues, 20);
            
            chart.data.labels = majorHist.labels;
            chart.data.datasets[0].data = majorHist.data;
            chart.data.datasets[1].data = minorHist.data;
            chart.update('none'); // Update without animation for performance
            
            // Update stats
            document.getElementById(`major-count-${safeId}`).textContent = data.majorValues.length;
            document.getElementById(`minor-count-${safeId}`).textContent = data.minorValues.length;
            document.getElementById(`max-major-${safeId}`).textContent = Math.max(...data.majorValues).toFixed(4);
            document.getElementById(`min-minor-${safeId}`).textContent = Math.min(...data.minorValues).toFixed(4);
            
            // Update Min Gap
            if (minGaps && minGaps[symbolKey]) {
                document.getElementById(`min-gap-${safeId}`).textContent = minGaps[symbolKey];
            }
        }
        
        function createHistogramData(values, bins) {
            if (values.length === 0) return { labels: [], data: [] };
            
            const min = Math.min(...values);
            const max = Math.max(...values);
            const binWidth = (max - min) / bins;
            
            const labels = [];
            const data = new Array(bins).fill(0);
            
            // Create bin labels
            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binWidth;
                const binEnd = min + (i + 1) * binWidth;
                labels.push(`${binStart.toFixed(3)}-${binEnd.toFixed(3)}`);
            }
            
            // Count values in each bin
            values.forEach(value => {
                let binIndex = Math.floor((value - min) / binWidth);
                if (binIndex >= bins) binIndex = bins - 1; // Handle edge case
                if (binIndex < 0) binIndex = 0;
                data[binIndex]++;
            });
            
            return { labels, data };
        }
        
        function submitValues(symbolKey, safeId) {
            const majorInput = document.getElementById(`major-input-${safeId}`);
            const minorInput = document.getElementById(`minor-input-${safeId}`);
            const depthInput = document.getElementById(`depth-input-${safeId}`);
            
            const majorValue = parseFloat(majorInput.value);
            const minorValue = parseFloat(minorInput.value);
            const depthValue = parseInt(depthInput.value);
            
            // Validate inputs
            if (isNaN(majorValue) || isNaN(minorValue)) {
                alert('Please enter valid numbers for both Major and Minor values.');
                return;
            }
            
            if (isNaN(depthValue) || depthValue < 1) {
                alert('Please enter a valid depth (minimum 1).');
                return;
            }
            
            // Calculate difference (Major - Minor)
            const difference = majorValue - minorValue;
            
            // Store values
            if (!storedValues[symbolKey]) {
                storedValues[symbolKey] = {};
            }
            storedValues[symbolKey].major = majorValue;
            storedValues[symbolKey].minor = minorValue;
            storedValues[symbolKey].difference = difference;
            storedValues[symbolKey].depth = depthValue;
            storedValues[symbolKey].remainingTriggers = depthValue;
            
            // Set execution state to Active (1)
            executionStates[symbolKey] = 1;
            
            // Send execution activation to feed.js server
            const activationMessage = JSON.stringify({
                type: 'execution-activated',
                symbolKey: symbolKey,
                storedMajor: majorValue,
                storedMinor: minorValue,
                difference: difference,
                depth: depthValue,
                remainingTriggers: depthValue
            });
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(activationMessage);
                console.log(`Sent activation signal for ${symbolKey}`);
            }
            
            // Update display
            document.getElementById(`stored-major-${safeId}`).textContent = majorValue.toFixed(4);
            document.getElementById(`stored-minor-${safeId}`).textContent = minorValue.toFixed(4);
            document.getElementById(`stored-difference-${safeId}`).textContent = difference.toFixed(4);
            document.getElementById(`stored-depth-${safeId}`).textContent = depthValue;
            document.getElementById(`remaining-triggers-${safeId}`).textContent = depthValue;
            document.getElementById(`execution-state-${safeId}`).textContent = 'Active';
            document.getElementById(`execution-state-${safeId}`).style.color = '#4CAF50';
            
            // Disable submit button
            const submitBtn = document.querySelector(`#wrapper-${safeId} .submit-btn`);
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.backgroundColor = '#666';
                submitBtn.style.cursor = 'not-allowed';
            }
            
            // Clear input fields
            majorInput.value = '';
            minorInput.value = '';
            depthInput.value = '1'; // Reset to default
            
            console.log(`Stored values for ${symbolKey}:`, storedValues[symbolKey]);
            console.log(`Execution state for ${symbolKey}: Active`);
        }
        
        function resetExecutionState(symbolKey) {
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            
            // Set execution state to Inactive (0)
            executionStates[symbolKey] = 0;
            
            // Send execution deactivation to feed.js server
            const deactivationMessage = JSON.stringify({
                type: 'execution-deactivated',
                symbolKey: symbolKey
            });
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(deactivationMessage);
                console.log(`Sent deactivation signal for ${symbolKey}`);
            }
            
            // Update display
            document.getElementById(`execution-state-${safeId}`).textContent = 'Inactive';
            document.getElementById(`execution-state-${safeId}`).style.color = '#ff6b6b';
            
            // Enable submit button
            const submitBtn = document.querySelector(`#wrapper-${safeId} .submit-btn`);
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.style.backgroundColor = '#007acc';
                submitBtn.style.cursor = 'pointer';
            }
            
            console.log(`Execution state for ${symbolKey}: Inactive`);
        }
        
        function updateRemainingTriggers(symbolKey, remainingCount) {
            const safeId = symbolKey.replace(/[^a-zA-Z0-9]/g, '_');
            const remainingElement = document.getElementById(`remaining-triggers-${safeId}`);
            
            if (remainingElement) {
                remainingElement.textContent = remainingCount;
                
                // Update stored values
                if (storedValues[symbolKey]) {
                    storedValues[symbolKey].remainingTriggers = remainingCount;
                }
                
                console.log(`Updated remaining triggers for ${symbolKey}: ${remainingCount}`);
            }
        }
        
        function updateLiveDifference(symbolKey, safeId) {
            const majorInput = document.getElementById(`major-input-${safeId}`);
            const minorInput = document.getElementById(`minor-input-${safeId}`);
            const liveDiffDisplay = document.getElementById(`live-difference-${safeId}`);
            
            const majorValue = parseFloat(majorInput.value);
            const minorValue = parseFloat(minorInput.value);
            
            if (!isNaN(majorValue) && !isNaN(minorValue)) {
                const difference = majorValue - minorValue;
                liveDiffDisplay.textContent = difference.toFixed(4);
            } else if (!isNaN(majorValue) && isNaN(minorValue)) {
                liveDiffDisplay.textContent = `${majorValue.toFixed(4)} - ?`;
            } else if (isNaN(majorValue) && !isNaN(minorValue)) {
                liveDiffDisplay.textContent = `? - ${minorValue.toFixed(4)}`;
            } else {
                liveDiffDisplay.textContent = '-';
            }
        }
    </script>
</body>
</html>